# テスト戦略

Hermesプロジェクトでは、品質を保証するために以下の3つのレベルのテストを導入しています。

-   **単体テスト (Unit Tests)**: `tests/unit`
-   **統合テスト (Integration Tests)**: `tests/integration`
-   **E2Eテスト (End-to-End Tests)**: `tests/e2e`

テストの実行は `pytest` を使用して行います。

```bash
# すべてのテストを実行
pytest

# カバレッジを計測
pytest --cov=hermes_cli
```

## 単体テスト (`tests/unit`)

単体テストは、個々のコンポーネント（クラスや関数）が期待通りに動作することを確認します。外部サービス（LLM、Web検索、データベースなど）への依存は、モックを使用して排除します。

-   **目的**:
    -   各関数のロジックの正当性を検証する。
    -   エッジケースや異常系の動作を確認する。
    -   高速に実行できるようにし、開発中の継続的なフィードバックを提供する。
-   **主な対象**:
    -   `services`: 各サービスクラスのビジネスロジック。
    -   `repositories`: 永続化層のロジック（ファイルI/Oはモック化）。
    -   `agents.nodes`: ワークフローを構成する各ノードの純粋なロジック。
    -   `clients`: 外部APIクライアントの基本的なリクエスト構築やレスポンス解析。

## 統合テスト (`tests/integration`)

統合テストは、複数のコンポーネントを組み合わせて、それらが連携して正しく動作することを確認します。単体テストでモック化した外部サービス（データベースなど）の一部を、テスト用のコンテナ（Docker）などを使用して実際に接続します。

-   **目的**:
    -   サービスとリポジトリ間のインタラクションを検証する。
    -   データベースやファイルシステムとの実際のやり取りを確認する。
    -   コンポーネント間のデータの受け渡しや契約が正しいことを保証する。
-   **主な対象**:
    -   `TaskService` と `TaskRepository` の連携。
    -   `HistoryService` と `HistoryRepository` の連携。
    -   エージェントのワークフロー全体（ただし、LLMやWeb検索などの外部APIはモック化）。

## E2Eテスト (`tests/e2e`)

E2Eテストは、ユーザーの視点からアプリケーション全体が期待通りに動作することを確認します。CLIコマンドの実行から、レポートが正しく生成されるまでの一連のフローをテストします。OllamaやSearxNGなどのすべての外部サービスを実際に起動してテストを実行します。

-   **目的**:
    -   実際の使用シナリオをシミュレートし、システム全体の動作を保証する。
    -   設定、コマンド、サービス、外部サービス間のすべての連携が正しく機能することを確認する。
    -   リグレッション（意図しない変更によるバグ）を検知する。
-   **主な対象**:
    -   `hermes run` コマンドの実行。
    -   `hermes task` と `hermes run --task-id` の連携。
    -   設定ファイル (`config.yaml`) の読み込みとCLIオプションによる上書き。
    -   最終的なレポートの生成と内容の検証。
