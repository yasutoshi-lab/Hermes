
# Hermes 詳細設計書

## 1. 文書情報

- 文書名: Hermes 詳細設計書
- 対象システム: CLI 情報収集 Agent「Hermes」
- 想定読者: アプリケーション開発者 / インフラ担当 / 将来の保守担当者
- バージョン: 1.0.0
- 作成日: 2025-11-14

---

## 2. システム概要

### 2.1 システム目的

Hermes は、研究者・開発者向けの CLI 型情報収集エージェントである。  
ローカルで動作する LLM（主に gpt-oss:20b）と、ブラウザ自動化ツールおよびコンテナ実行環境を連携させ、以下を自動化する。

- Web 情報の収集
- コンテナ環境内での前処理・分析
- 検証ループを伴う回答のブラッシュアップ
- 最終レポートのマークダウン出力と履歴管理

### 2.2 主要コンポーネント

- CLI アプリケーション (`hermes` コマンド)
- LangGraph によるエージェントワークフロー
- browser-use ライブラリによるブラウザ操作
- container-use ツールによるコンテナ環境実行
- Ollama API 経由の gpt-oss:20b
- ファイルベースの永続化層（task, history, log, debug_log, cache, config）

---

## 3. 実行環境・依存関係

### 3.1 対応 OS

- Linux: 主に Ubuntu 系を想定
- Windows: PowerShell からの利用を想定

### 3.2 言語・ランタイム

- プログラミング言語: Python 3.10 以上
- パッケージ管理: `uv` または `pip`

### 3.3 主な Python 依存ライブラリ

- CLI フレームワーク: `typer` または `click`
- LLM クライアント:
  - `httpx` または `requests`（Ollama HTTP API 用）
- エージェント/ワークフロー:
  - `langgraph`
  - `pydantic`（状態スキーマ定義用）
- ツール連携:
  - `browser_use`
  - `dagger-io`（container-use の実装に依存）
- 共通:
  - `pyyaml`
  - `rich`（ログ・CLI 出力整形用）
  - `watchdog`（ログファイル監視用、任意）

実際の requirements 例:

```txt
typer
httpx
langgraph
pydantic
browser-use
dagger-io
pyyaml
rich
watchdog
```

### 3.4 LLM モデル前提

- モデル: `gpt-oss:20b`
- 起動方法: Ollama でモデルをローカルにロードしておく
- デフォルト API エンドポイント: `http://localhost:11434/api/chat`

---

## 4. ディレクトリ・ファイル構成

### 4.1 ユーザーデータディレクトリ

`hermes init` 実行時に、以下を作成する。

```text
~/.hermes/
├── cache          # 一時キャッシュ
├── config.yaml    # 設定ファイル
├── task           # スケジューリングされたタスク定義
├── log            # 実行ログ
├── debug_log      # 詳細デバッグログ
└── history        # 実行結果レポートとメタ情報
```

Windows の場合は、`%USERPROFILE%\.hermes` をベースパスとする。

### 4.2 アプリケーション側ディレクトリ例

```text
hermes/
├── hermes_cli/
│   ├── __init__.py
│   ├── main.py              # エントリポイント
│   ├── commands/
│   │   ├── init_cmd.py
│   │   ├── task_cmd.py
│   │   ├── run_cmd.py
│   │   ├── log_cmd.py
│   │   ├── history_cmd.py
│   │   └── debug_cmd.py
│   ├── services/
│   │   ├── config_service.py
│   │   ├── task_service.py
│   │   ├── run_service.py
│   │   ├── log_service.py
│   │   ├── history_service.py
│   │   └── debug_service.py
│   ├── agents/
│   │   ├── graph.py         # LangGraph 定義
│   │   ├── state.py         # 状態スキーマ
│   │   └── nodes/           # 各ノード実装
│   ├── tools/
│   │   ├── ollama_client.py
│   │   ├── browser_use_client.py
│   │   └── container_use_client.py
│   └── persistence/
│       ├── file_paths.py
│       ├── task_repository.py
│       ├── history_repository.py
│       ├── log_repository.py
│       └── config_repository.py
└── pyproject.toml / setup.cfg
```

---

## 5. 設定ファイル仕様（config.yaml）

### 5.1 全体構造

```yaml
ollama:
  api_base: "http://localhost:11434/api/chat"
  model: "gpt-oss:20b"
  retry: 3
  timeout_sec: 60

language: "ja"  # "ja" or "en"

validation:
  min_loops: 1
  max_loops: 3

search:
  min_sources: 3
  max_sources: 8

logging:
  level: "INFO"          # DEBUG / INFO / WARNING / ERROR
  log_dir: "~/.hermes/log"
  debug_log_dir: "~/.hermes/debug_log"

task:
  default_schedule: "manual"

cli:
  history_limit: 100      # history コマンドで表示する最大件数
```

### 5.2 各項目の意味

- `ollama.api_base`  
  - Ollama API のベース URL。`--api` オプションにより一時的に上書き可能。
- `ollama.model`  
  - 使用するモデル名。`--model` で上書き可能。
- `ollama.retry` / `ollama.timeout_sec`  
  - LLM 呼び出しのリトライ回数とタイムアウト秒数。
- `language`  
  - Hermes のデフォルト出力言語。
- `validation.min_loops` / `max_loops`  
  - 検証ループの最小 / 最大実行回数。
- `search.min_sources` / `max_sources`  
  - 1 クエリあたり、browser-use で収集する情報源数の範囲。
- `logging.*`  
  - ログファイルの出力先とログレベルを制御。
- `cli.history_limit`  
  - history コマンドで一覧に表示する最大件数。

---

## 6. データモデル

### 6.1 Task モデル

```python
from dataclasses import dataclass
from datetime import datetime
from typing import Literal

Status = Literal["scheduled", "running", "done", "failed"]

@dataclass
class Task:
    id: str
    prompt: str
    created_at: datetime
    status: Status
    options: dict  # language, min_validation, max_validation, query_count...
```

- 保存形式: `task/task-<TASK-ID>.yaml`
- YAML 例:

```yaml
id: "2025-0001"
prompt: "量子計算におけるエラー訂正手法の比較"
created_at: "2025-11-14T10:23:00+09:00"
status: "scheduled"
options:
  language: "ja"
  min_validation: 1
  max_validation: 3
  query_count: 5
```

### 6.2 History モデル

```python
from dataclasses import dataclass
from datetime import datetime

@dataclass
class HistoryMeta:
    id: str
    prompt: str
    created_at: datetime
    finished_at: datetime
    model: str
    language: str
    validation_loops: int
    source_count: int
    report_file: str
```

- メタ情報保存形式: `history/report-<TASK-ID>.meta.yaml`
- レポート本体: `history/report-<TASK-ID>.md`

### 6.3 ログエントリ形式

ログはテキストファイルとし、1 行 1 イベントで記録する。

```text
<ISO8601時刻> [<レベル>] [<コンポーネント>] <メッセージ> [key=value ...]
```

例:

```text
2025-11-14T10:31:02+09:00 [INFO] [RUN] task_id=2025-0001 phase=query_generation
2025-11-14T10:31:03+09:00 [INFO] [BROWSER] task_id=2025-0001 query_idx=0 source_count=5
2025-11-14T10:31:05+09:00 [ERROR] [OLLAMA] task_id=2025-0001 reason=timeout retry=1
```

`debug_log` には、同様の形式でより詳細な情報（ステートダンプなど）を出力する。

### 6.4 LangGraph 状態モデル

```python
from typing import Dict, List, Optional
from pydantic import BaseModel

class HermesState(BaseModel):
    user_prompt: str
    language: str
    queries: List[str]
    query_results: Dict[str, List[dict]]  # query -> sources
    processed_notes: Dict[str, str]       # query -> normalized text
    draft_report: Optional[str] = None
    validated_report: Optional[str] = None
    loop_count: int = 0
    min_validation: int = 1
    max_validation: int = 3
```

---

## 7. CLI インタフェース詳細

### 7.1 共通仕様

- コマンド名: `hermes`
- サブコマンド:
  - `init`
  - `task`
  - `run`
  - `log`
  - `history`
  - `debug`
- 返却コード:
  - `0`: 正常終了
  - `1`: 一般的なエラー
  - `2`: ユーザー入力不正
  - `3`: 外部ツールエラー（Ollama, browser-use, container-use など）

---

### 7.2 `hermes init`

**役割**: データ保存用ディレクトリの初期化。

- 実装関数例: `commands.init_cmd.init()`
- 処理フロー:
  1. `Path.home()` を取得し OS ごとにパスを決定。
  2. `.hermes` 以下のサブディレクトリを作成（既存ならスキップ）。
  3. `config.yaml` が存在しなければデフォルト値で生成。
  4. 成功メッセージを標準出力。

---

### 7.3 `hermes task`

**役割**: タスクスケジューリング（登録・一覧・削除）。

#### オプション仕様

- `--prompt "<タスクプロンプト>"`  
  - 新規タスクを作成し、`task-<TASK-ID>.yaml` を生成。
- `--list`  
  - `task/` ディレクトリを走査し、Task を一覧表示。
- `--deleate <TASK-ID>`  
  - 指定 ID のタスクファイルを削除。
  - 実装では `--delete` エイリアスも許容しておくとユーザビリティが高い。

#### 表示フォーマット

`--list` の出力例:

```text
TASK-ID    CREATED_AT              STATUS      PROMPT
2025-0001  2025-11-14 10:23:00     scheduled   量子計算におけるエラー訂正手法の比較
2025-0002  2025-11-14 11:10:05     done        生成系モデルの評価指標
```

---

### 7.4 `hermes run`

**役割**: タスクの実行／単発リサーチの実行。

#### 主なオプション

- `--prompt "<プロンプト>"`  
  - 単発実行モード。task は作らず、その場で run。
- `--export <PATH>`  
  - 直近のタスク結果を指定パスへコピー。
- `--api <URL>`  
  - Ollama API ベース URL（config を一時上書き）。
- `--model <MODEL_NAME>`  
  - 使用モデル名。
- `--min-validation <N>` / `--max-validation <N>`
- `--query <N>`  
  - クエリ生成数。
- `--clear`  
  - `config.yaml` を初期状態に戻す。
- `--language <ja|en>`  
  - 出力言語。
- `--retry <N>`  
  - Ollama リトライ回数。
- `--max-search <N>` / `--min-search <N>`

#### 処理シーケンス（単発実行）

1. `config_service` で `config.yaml` を読み込み、CLI オプションで上書き。
2. 一時的な Task ID を生成し、ログを開始。
3. LangGraph のエグゼキュータに初期状態 (`HermesState`) を渡して実行。
4. エージェントが最終レポートを生成。
5. history ディレクトリに `report-<TASK-ID>.md` とメタファイルを保存。
6. `--export` 指定があれば、レポートファイルを指定パスにコピー。
7. 結果概要（タスク ID、出力ファイルパス）を標準出力。

#### 処理シーケンス（将来拡張: 事前登録タスク実行）

- `--task-id <TASK-ID>` オプションを追加する想定。
- 指定された Task をロードして上記フローを実行。

---

### 7.5 `hermes log`

**役割**: 実行中タスクのログをリアルタイム表示。

#### 振る舞い

- デフォルトでは「最新の running 状態 Task」を対象に log ファイルを tail。
- 将来的に `--task-id` オプションで対象を指定可能にする。

#### 表示例

```text
2025-11-14T10:31:02+09:00 [INFO] [RUN] task_id=2025-0001 phase=browser_search
2025-11-14T10:31:03+09:00 [INFO] [BROWSER] task_id=2025-0001 query_idx=0 source_count=3
2025-11-14T10:31:05+09:00 [INFO] [CONTAINER] task_id=2025-0001 step=normalize_text
2025-11-14T10:31:10+09:00 [INFO] [LLM] task_id=2025-0001 phase=draft_generation
```

---

### 7.6 `hermes history`

**役割**: 過去タスクと成果物の管理。

#### 機能

- デフォルト: history ディレクトリ内のメタファイルを読み込み、一覧表示。
- `--export <TASK-ID> <PATH>`  
  - 対象レポートを PATH へコピー。
- `--deleate <TASK-ID>`  
  - レポートとメタファイルを削除。

#### 表示例

```text
TASK-ID    CREATED_AT              FINISHED_AT             MODEL         LOOPS SOURCES
2025-0001  2025-11-14 10:23:00     2025-11-14 10:45:12     gpt-oss:20b   2     13
```

---

### 7.7 `hermes debug`

**役割**: システム全体のログのリアルタイム追跡。

#### オプション

- `--info`
- `--warning`
- `--error`
- `--all`

#### 振る舞い

- `log/` と `debug_log/` の両方を対象とし、レベルフィルタに従って tail 表示。
- 内部的には Python logging のハンドラ設定に依存。

---

## 8. 内部モジュール設計

### 8.1 ConfigService

- 役割:
  - `config.yaml` の読み書き
  - デフォルト値の生成
  - CLI オプションによる一時上書き
- 主なメソッド:
  - `load() -> Config`
  - `save(config: Config) -> None`
  - `reset_to_default() -> None`
  - `apply_overrides(config: Config, overrides: dict) -> Config`

### 8.2 TaskService

- 役割:
  - Task の登録・一覧・削除
- 主なメソッド:
  - `create_task(prompt: str, options: dict) -> Task`
  - `list_tasks() -> list[Task]`
  - `delete_task(task_id: str) -> None`
  - `get_latest_running_task() -> Task | None`

### 8.3 RunService

- 役割:
  - LangGraph 実行の統括
  - history への保存
- 主なメソッド:
  - `run_prompt(prompt: str, options: dict) -> HistoryMeta`
  - `run_task(task_id: str) -> HistoryMeta`

### 8.4 HistoryService

- 役割:
  - history メタの読み書き
  - レポートファイルのコピー・削除
- 主なメソッド:
  - `list_history(limit: int) -> list[HistoryMeta]`
  - `get_history(task_id: str) -> HistoryMeta`
  - `export_report(task_id: str, dest_path: Path) -> None`
  - `delete_history(task_id: str) -> None`

### 8.5 LogService / DebugService

- 役割:
  - ログの tail 表示
  - レベルフィルタ適用
- 実装案:
  - `watchdog` でファイル更新を監視
  - または一定間隔ポーリングで末尾を読み出し

---

## 9. LangGraph ワークフロー設計

### 9.1 ノード一覧

1. `prompt_normalizer`
2. `query_generator`
3. `web_researcher`
4. `container_processor`
5. `draft_aggregator`
6. `validation_controller`
7. `validator`
8. `final_reporter`

### 9.2 状態遷移概要

```text
user_prompt
  ↓
prompt_normalizer
  ↓
query_generator
  ↓
web_researcher (query ごとに分岐し並列実行可)
  ↓
container_processor
  ↓
draft_aggregator
  ↓
validation_controller ──┐
  ├─ ループ継続 → validator → web_researcher(検証用) → container_processor → draft_aggregator
  └─ 完了       → final_reporter
```

### 9.3 各ノード詳細（概要）

- `PromptNormalizer`  
  言語設定に応じてプロンプトを正規化。
- `QueryGenerator`  
  LLM を使って複数の検索クエリを生成。
- `WebResearcher`  
  browser-use で Web 検索と情報取得。
- `ContainerProcessor`  
  取得コンテンツをコンテナ内で正規化。
- `DraftAggregator`  
  暫定レポートを生成。
- `ValidationController`  
  検証ループ回数に基づき、継続か終了かを判定。
- `Validator`  
  暫定レポートを検証・修正。
- `FinalReporter`  
  最終マークダウンレポートを生成。

---

## 10. ツールアダプタ設計

### 10.1 OllamaClient

- Hermes 内からの LLM 呼び出しを抽象化するクラス。
- 主なメソッド:
  - `chat(messages: list[dict]) -> str`

### 10.2 BrowserUseClient

- browser-use をラップし、Hermes からは抽象化されたインタフェースで利用可能にする。
- 主なメソッド:
  - `search(query: str, max_sources: int) -> list[dict]`

### 10.3 ContainerUseClient

- container-use によるテキスト前処理やその他計算処理をラップ。
- 主なメソッド:
  - `normalize_texts(texts: list[str]) -> list[str]`

---

## 11. ロギング・エラーハンドリング

### 11.1 ロギングポリシ

- ログレベル:
  - DEBUG / INFO / WARNING / ERROR
- 出力先:
  - 通常ログ: `log/`
  - 詳細ログ: `debug_log/`
- ローテーション:
  - 初期実装では日付単位のファイル (`hermes-YYYYMMDD.log`) とする。

### 11.2 エラーハンドリング指針

1. **Ollama エラー**
   - タイムアウト・接続失敗時はリトライ。
   - リトライ上限超過時はタスクを `failed` とし、history に失敗要因を記録。

2. **browser-use / container-use エラー**
   - 特定クエリの処理失敗時:
     - そのクエリをスキップし、他のクエリで処理を継続。
   - 全クエリ失敗時:
     - タスク全体を失敗扱いとする。

3. **設定ファイルエラー**
   - パース失敗時はデフォルト設定を用いて再生成し、警告を出力。

---

## 12. セキュリティ・国際化

### 12.1 セキュリティ

- 外部 API として利用するのはローカルの Ollama のみを前提。
- browser-use の認証情報は `.env` などに保存。
- コンテナ環境では書き込み可能範囲を限定したボリュームのみをマウント。

### 12.2 国際化

- `language` 設定と `--language` オプションに応じて、
  - システムプロンプト
  - レポート章タイトル
  - 一部メッセージ
  を切り替える。

---

